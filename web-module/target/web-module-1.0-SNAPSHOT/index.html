<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributed Online Auction System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f2f5;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23000000' fill-opacity='0.03'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0H5v5H0v1h5v94h1V6h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .card-shadow:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(-4px);
        }

        .primary-button {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            transition: all 0.3s ease;
        }

        .primary-button:hover {
            background: linear-gradient(135deg, #4338ca, #6d28d9);
            transform: translateY(-1px);
        }

        .secondary-button {
            transition: all 0.3s ease;
        }

        .secondary-button:hover {
            transform: translateY(-1px);
        }

        .input-field {
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .log-container {
            max-height: 200px;
            overflow-y: auto;
        }

        .log-container::-webkit-scrollbar {
            width: 6px;
        }

        .log-container::-webkit-scrollbar-track {
            background: rgba(243, 244, 246, 0.1);
        }

        .log-container::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.3);
            border-radius: 3px;
        }

        .log-container::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.5);
        }

        /* Auction card animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auction-card {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>

<div class="container mx-auto p-6 max-w-6xl">
    <header class="mb-10">
        <h1 class="text-4xl md:text-5xl font-bold text-center text-indigo-900 tracking-tight">
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600">
                Online Auction System
            </span>
        </h1>
        <p class="text-center text-gray-600 mt-2">Bid, win, and trade securely</p>
    </header>

    <!-- User Info & Logout -->
    <div id="user-info" class="bg-white rounded-lg shadow-md px-6 py-4 mb-8 hidden flex items-center justify-between" role="alert">
        <span class="text-gray-700">Welcome, <span id="current-username" class="font-semibold text-indigo-700"></span></span>
        <button id="logout-btn" class="primary-button text-white font-medium py-2 px-4 rounded-lg">Logout</button>
    </div>

    <!-- Auth Section -->
    <div id="auth-section" class="bg-white rounded-lg shadow-lg p-8 mb-10 max-w-md mx-auto card-shadow">
        <h2 id="auth-title" class="text-2xl font-semibold text-gray-800 mb-6">Login to Bid</h2>
        <form id="auth-form">
            <div class="mb-5">
                <label for="auth-username" class="block text-gray-700 text-sm font-medium mb-2">Username</label>
                <input type="text" id="auth-username" class="input-field w-full px-4 py-2 rounded-lg focus:outline-none bg-gray-50" required>
            </div>
            <div class="mb-6">
                <label for="auth-password" class="block text-gray-700 text-sm font-medium mb-2">Password</label>
                <input type="password" id="auth-password" class="input-field w-full px-4 py-2 rounded-lg focus:outline-none bg-gray-50" required>
            </div>
            <div class="flex items-center justify-between">
                <button type="submit" id="auth-submit-btn" class="primary-button text-white font-medium py-2 px-6 rounded-lg">
                    Login
                </button>
                <button type="button" id="toggle-auth-mode-btn" class="text-indigo-600 font-medium hover:text-indigo-500">
                    Register Instead
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-4" id="auth-hint">Demo Users: user1/pass1, user2/pass2</p>
        </form>
        <p id="auth-message" class="text-red-500 text-sm mt-4"></p>
    </div>

    <!-- Auction List Section -->
    <div id="auction-list-section" class="hidden space-y-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Active Auctions</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="auction-list">
            <!-- Auction cards will be loaded here -->
        </div>
    </div>

    <!-- Auction Log -->
    <div class="bg-white rounded-lg shadow-lg p-6 card-shadow">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Real-time Auction Log</h2>
        <div id="auction-log" class="log-container rounded-lg p-4 text-sm bg-gray-50 border border-gray-100">
            <!-- Log messages will appear here -->
        </div>
    </div>
</div>

<script>
    const authSection = document.getElementById('auth-section');
    const authTitle = document.getElementById('auth-title');
    const authForm = document.getElementById('auth-form');
    const authUsernameInput = document.getElementById('auth-username');
    const authPasswordInput = document.getElementById('auth-password');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const toggleAuthModeBtn = document.getElementById('toggle-auth-mode-btn');
    const authMessage = document.getElementById('auth-message');
    const authHint = document.getElementById('auth-hint');

    const userInfoDiv = document.getElementById('user-info');
    const currentUsernameSpan = document.getElementById('current-username');
    const logoutBtn = document.getElementById('logout-btn');
    const auctionListSection = document.getElementById('auction-list-section');
    const auctionListDiv = document.getElementById('auction-list');
    const auctionLog = document.getElementById('auction-log');

    let websocket;
    const CONTEXT_ROOT = '/auction-system';
    let isLoginMode = true; // State for login vs registration

    // --- Authentication Functions ---
    async function handleAuthSubmit(event) {
        event.preventDefault();
        const username = authUsernameInput.value;
        const password = authPasswordInput.value;
        let url, method;

        if (isLoginMode) {
            url = `${CONTEXT_ROOT}/api/auth/login`;
            method = 'Login';
        } else {
            url = `${CONTEXT_ROOT}/api/auth/register`;
            method = 'Register';
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();

            if (response.ok || response.status === 201) { // 201 Created for registration
                authMessage.textContent = data.message || `${method} successful.`;
                authMessage.className = 'text-green-600 text-sm mt-4';
                if (isLoginMode) { // Only attempt UI update on successful login
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('currentUsername', data.username);
                    updateUIForLogin(data.username);
                    fetchAuctions();
                    connectWebSocket(); // This will connect, but updates won't flow from MDB if commented out
                } else { // After successful registration, switch to login mode
                    switchAuthMode(true);
                    authUsernameInput.value = username; // Keep username
                    authPasswordInput.value = ''; // Clear password
                }
            } else {
                authMessage.textContent = data.message || `${method} failed.`;
                authMessage.className = 'text-red-500 text-sm mt-4';
            }
        } catch (error) {
            authMessage.textContent = `Network error during ${method.toLowerCase()}.`;
            authMessage.className = 'text-red-600 text-sm mt-4';
            console.error(`${method} error:`, error);
        }
    }

    function switchAuthMode(toLogin) {
        isLoginMode = toLogin;
        authTitle.textContent = isLoginMode ? 'Login to Bid' : 'Register New User';
        authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Register';
        toggleAuthModeBtn.textContent = isLoginMode ? 'Register Instead' : 'Login Instead';
        authHint.textContent = isLoginMode ? 'Demo Users: user1/pass1, user2/pass2' : 'Choose a unique username and strong password.';
        authMessage.textContent = ''; // Clear messages
        authForm.reset(); // Clear form fields
    }

    async function handleLogout() {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        try {
            const response = await fetch(`${CONTEXT_ROOT}/api/auth/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                logMessage('Logged out successfully.', 'text-green-600');
            } else {
                logMessage('Logout failed. Token might be invalid or expired on server.', 'text-red-500');
            }
        } catch (error) {
            logMessage('Network error during logout.', 'text-red-600');
            console.error('Logout error:', error);
        } finally {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUsername');
            updateUIForLogout();
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close();
            }
        }
    }

    function updateUIForLogin(username) {
        authSection.classList.add('hidden');
        auctionListSection.classList.remove('hidden');
        userInfoDiv.classList.remove('hidden');
        currentUsernameSpan.textContent = username;
    }

    function updateUIForLogout() {
        authSection.classList.remove('hidden');
        auctionListSection.classList.add('hidden');
        userInfoDiv.classList.add('hidden');
        auctionListDiv.innerHTML = '<p class="col-span-full text-center text-gray-500 p-8 bg-white rounded-lg shadow">Please login or register to view auctions.</p>';
    }

    // --- WebSocket Functions ---
    function connectWebSocket() {
        if (websocket && (websocket.readyState === WebSocket.OPEN || websocket.readyState === WebSocket.CONNECTING)) {
            return;
        }

        const wsUrl = `ws://${window.location.host}${CONTEXT_ROOT}/auctionUpdates`;
        websocket = new WebSocket(wsUrl);

        websocket.onopen = function(event) {
            logMessage('WebSocket connected.', 'text-green-600');
        };

        websocket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.auctionId && data.currentBid !== undefined && data.winningBidder) {
                    updateAuctionCard(data);
                    logMessage(`Auction ${data.title} (#${data.auctionId}): New bid $${data.currentBid.toFixed(2)} by ${data.winningBidder}`, 'text-blue-600');
                } else {
                    logMessage(`Server: ${event.data}`, 'text-gray-600');
                }
            } catch (e) {
                logMessage(`Server: ${event.data}`, 'text-gray-600');
            }
        };

        websocket.onclose = function(event) {
            logMessage('WebSocket disconnected. Trying to reconnect in 5 seconds...', 'text-amber-600');
            if (localStorage.getItem('authToken')) {
                setTimeout(connectWebSocket, 5000);
            }
        };

        websocket.onerror = function(error) {
            logMessage('WebSocket error: ' + error.message, 'text-red-600');
        };
    }

    // --- Auction Listing & Bidding Functions ---
    async function fetchAuctions() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            logMessage('Not authenticated. Please login or register to fetch auctions.', 'text-amber-600');
            auctionListDiv.innerHTML = '<p class="col-span-full text-center text-gray-500 p-8 bg-white rounded-lg shadow">Please login or register to view auctions.</p>';
            return;
        }

        try {
            const response = await fetch(`${CONTEXT_ROOT}/api/auctions`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) {
                if (response.status === 401) {
                    logMessage('Authentication failed for fetching auctions. Please re-login.', 'text-red-500');
                    handleLogout();
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const auctions = await response.json();
            auctionListDiv.innerHTML = '';

            if (auctions.length === 0) {
                auctionListDiv.innerHTML = '<p class="col-span-full text-center text-gray-500 p-8 bg-white rounded-lg shadow">No active auctions available.</p>';
                return;
            }

            auctions.forEach(auction => {
                const card = createAuctionCard(auction);
                function createAuctionCard(auction) {
                    const card = document.createElement('div');
                    card.id = `auction-${auction.id}`;
                    card.className = 'bg-white rounded-xl shadow-lg p-0 flex flex-col card-shadow auction-card overflow-hidden';

                    // Calculate time remaining for demo purposes (just visual)
                    const randomHours = Math.floor(Math.random() * 24) + 1;
                    const randomMins = Math.floor(Math.random() * 60);

                    card.innerHTML = `
        <div class="bg-gradient-to-r from-indigo-600 to-violet-600 p-4 text-white">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">${auction.title}</h3>
                <span class="bg-white bg-opacity-20 backdrop-blur-sm text-white text-xs px-3 py-1 rounded-full">
                    #${auction.id}
                </span>
            </div>
        </div>

        <div class="p-5">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <div class="text-gray-500 text-xs uppercase font-medium tracking-wider mb-1">Current Bid</div>
                    <div id="current-bid-${auction.id}" class="font-bold text-indigo-600 text-3xl">
                        $${auction.currentBid.toFixed(2)}
                    </div>
                </div>
                <div class="bg-indigo-50 rounded-lg p-2 text-center min-w-[80px]">
                    <div class="text-indigo-400 text-xs font-medium">ENDS IN</div>
                    <div class="text-indigo-800 font-medium">${randomHours}h ${randomMins}m</div>
                </div>
            </div>

            <div class="mb-6 bg-gray-50 rounded-lg p-3">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-gray-500 text-xs uppercase font-medium tracking-wider mb-1">Leader</div>
                        <div id="winning-bidder-${auction.id}" class="font-semibold text-gray-800 flex items-center">
                            <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            ${auction.winningBidder || 'No bids yet'}
                        </div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs uppercase font-medium tracking-wider mb-1">Min Increment</div>
                        <div class="font-semibold text-gray-800">$${auction.minIncrement.toFixed(2)}</div>
                    </div>
                </div>
            </div>

            <form class="mt-4" data-auction-id="${auction.id}">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500 text-lg">$</span>
                    <input type="number"
                        step="0.01"
                        min="${auction.currentBid + auction.minIncrement}"
                        placeholder="Enter your bid amount"
                        class="input-field w-full p-4 pl-8 rounded-lg focus:outline-none bg-gray-50 border-2 border-indigo-50 hover:border-indigo-100 transition-colors"
                        required>
                </div>
                <button type="submit" class="primary-button w-full text-white py-4 rounded-lg font-semibold mt-3 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Place Bid
                </button>
            </form>
        </div>
    `;

                    const form = card.querySelector('form');
                    form.addEventListener('submit', handleBidSubmission);
                    return card;
                }
                auctionListDiv.appendChild(card);
            });
        } catch (error) {
            logMessage(`Failed to load auctions: ${error.message}`, 'text-red-600');
            auctionListDiv.innerHTML = '<p class="col-span-full text-center text-red-500 p-8 bg-white rounded-lg shadow">Error loading auctions. Check server status.</p>';
        }
    }

    function createAuctionCard(auction) {
        const card = document.createElement('div');
        card.id = `auction-${auction.id}`;
        card.className = 'bg-white rounded-lg shadow-lg p-6 flex flex-col justify-between card-shadow auction-card';
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">${auction.title}</h3>
                    <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">#${auction.id}</span>
                </div>
                <div class="mb-4">
                    <div class="text-gray-600 text-sm mb-1">Current Bid:</div>
                    <div id="current-bid-${auction.id}" class="font-bold text-indigo-600 text-2xl">$${auction.currentBid.toFixed(2)}</div>
                </div>
                <div class="mb-4">
                    <div class="text-gray-600 text-sm mb-1">Winning Bidder:</div>
                    <div id="winning-bidder-${auction.id}" class="font-medium text-gray-800">${auction.winningBidder || 'None'}</div>
                </div>
                <div class="text-gray-500 text-xs inline-block bg-gray-100 rounded-full px-3 py-1 mb-4">
                    Min Increment: $${auction.minIncrement.toFixed(2)}
                </div>
            </div>
            <form class="mt-4" data-auction-id="${auction.id}">
                <div class="relative">
                    <span class="absolute inset-y-0 left-3 flex items-center text-gray-500">$</span>
                    <input type="number"
                        step="0.01"
                        min="${auction.currentBid + auction.minIncrement}"
                        placeholder="Your Bid Amount"
                        class="input-field w-full pl-8 pr-3 py-3 rounded-lg focus:outline-none bg-gray-50"
                        required>
                </div>
                <button type="submit" class="primary-button w-full text-white py-3 rounded-lg font-medium mt-3">
                    Place Bid
                </button>
            </form>
        `;

        const form = card.querySelector('form');
        form.addEventListener('submit', handleBidSubmission);
        return card;
    }

    function updateAuctionCard(data) {
        const currentBidSpan = document.getElementById(`current-bid-${data.auctionId}`);
        const winningBidderSpan = document.getElementById(`winning-bidder-${data.auctionId}`);
        const bidInput = document.querySelector(`#auction-${data.auctionId} form input[type="number"]`);

        if (currentBidSpan) {
            currentBidSpan.textContent = `$${data.currentBid.toFixed(2)}`;
            // Highlight the updated bid with animation
            currentBidSpan.classList.add('text-green-600');
            setTimeout(() => {
                currentBidSpan.classList.remove('text-green-600');
            }, 2000);

            if (bidInput) {
                bidInput.min = (data.currentBid + (data.minIncrement || 0)).toFixed(2);
            }
        }
        if (winningBidderSpan) {
            winningBidderSpan.textContent = data.winningBidder || 'None';
            // Highlight the winning bidder with animation
            winningBidderSpan.classList.add('text-green-600');
            setTimeout(() => {
                winningBidderSpan.classList.remove('text-green-600');
            }, 2000);
        }
    }

    async function handleBidSubmission(event) {
        event.preventDefault();
        const form = event.target;
        const auctionId = form.dataset.auctionId;
        const bidAmount = form.querySelector('input[type="number"]').value;
        const token = localStorage.getItem('authToken');

        if (!token) {
            logMessage('You must be logged in to place a bid.', 'text-red-500');
            return;
        }
        if (bidAmount === '') {
            logMessage('Please enter a bid amount.', 'text-red-500');
            return;
        }

        const apiUrl = `${CONTEXT_ROOT}/api/auctions/${auctionId}/bid`;
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="animate-pulse">Processing...</span>';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': `Bearer ${token}`
                },
                body: new URLSearchParams({
                    bidAmount: parseFloat(bidAmount)
                })
            });

            const message = await response.text();
            if (response.ok || response.status === 202) {
                logMessage(`Bid for auction ${auctionId}: ${message}`, 'text-green-600');
                form.reset();
            } else if (response.status === 401) {
                logMessage(`Authentication failed for bid: ${message}. Please re-login.`, 'text-red-500');
                handleLogout();
            } else {
                logMessage(`Error bidding for auction ${auctionId}: ${message}`, 'text-red-500');
            }
        } catch (error) {
            logMessage(`Network error during bid submission: ${error.message}`, 'text-red-600');
            console.error('Bid submission error:', error);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Place Bid';
        }
    }

    function logMessage(message, className = '') {
        const p = document.createElement('p');
        p.className = `py-1 border-b border-gray-100 ${className}`;
        const timestamp = new Date().toLocaleTimeString();
        p.innerHTML = `
            <span class="text-gray-400 text-xs">${timestamp}</span>
            <span class="${className || 'text-gray-700'} ml-2">${message}</span>
        `;
        auctionLog.appendChild(p);
        auctionLog.scrollTop = auctionLog.scrollHeight;
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        authForm.addEventListener('submit', handleAuthSubmit);
        toggleAuthModeBtn.addEventListener('click', () => switchAuthMode(!isLoginMode));
        logoutBtn.addEventListener('click', handleLogout);

        const storedToken = localStorage.getItem('authToken');
        const storedUsername = localStorage.getItem('currentUsername');

        if (storedToken && storedUsername) {
            fetch(`${CONTEXT_ROOT}/api/auth/me`, {
                headers: { 'Authorization': `Bearer ${storedToken}` }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Token validation failed on server.');
                    }
                })
                .then(data => {
                    updateUIForLogin(data.username);
                    fetchAuctions();
                    connectWebSocket();
                })
                .catch(error => {
                    console.error('Initial token validation error:', error);
                    logMessage('Your session expired or is invalid. Please log in again.', 'text-red-500');
                    handleLogout();
                });
        } else {
            updateUIForLogout();
            switchAuthMode(true); // Default to login mode
            logMessage('Please log in or register to participate in auctions.', 'text-amber-600');
        }
    });
</script>

</body>
</html>